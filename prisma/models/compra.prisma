enum TipoDocumento {
    Factura          @map("01")
    Boleta           @map("03")
    NotaDeVenta      @map("nv")
    Ingreso          @map("in")
    Salida           @map("sa")
    RecepcionAlmacen @map("rc")
}

enum EstadoDeCompra {
    Creado    @map("cr")
    EnEspera  @map("ee")
    Anulado   @map("an")
    Procesado @map("pr")
}

enum FormaDePago {
    Contado  @map("co")
    Crédito @map("cr")
}

enum TipoMoneda {
    Soles    @map("s")
    Dólares @map("d")
}

model Compra {
    id Int @id @default(autoincrement())

    tipo_documento    TipoDocumento @default(NotaDeVenta)
    serie             String
    numero            Int
    descripcion       String?
    forma_de_pago     FormaDePago   @default(Contado)
    tipo_moneda       TipoMoneda    @default(Soles)
    tipo_de_cambio    Decimal       @default(1) @db.Decimal(9, 4)
    percepcion        Decimal       @default(0) @db.Decimal(9, 4)
    numero_dias       Int?
    fecha_vencimiento DateTime?
    fecha             DateTime

    user_id String
    user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

    almacen_id Int
    almacen    Almacen @relation(fields: [almacen_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    proveedor_id Int?
    proveedor    Proveedor? @relation(fields: [proveedor_id], references: [id], onDelete: Restrict, onUpdate: Cascade)

    productos_por_almacen ProductoAlmacenCompra[]

    estado_de_compra  EstadoDeCompra    @default(Creado)
    recepcion_almacen RecepcionAlmacen?

    @@unique([serie, numero, proveedor_id])
    @@index([fecha])
}

model ProductoAlmacenCompra {
    id Int @id @default(autoincrement())

    compra    Compra @relation(fields: [compra_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
    compra_id Int

    costo Decimal @db.Decimal(9, 4)

    producto_almacen    ProductoAlmacen @relation(fields: [producto_almacen_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
    producto_almacen_id Int

    unidades_derivadas UnidadDerivadaInmutableCompra[]

    @@unique([compra_id, producto_almacen_id])
}

model UnidadDerivadaInmutableCompra {
    id Int @id @default(autoincrement())

    unidad_derivada_inmutable_id Int
    unidad_derivada_inmutable    UnidadDerivadaInmutable @relation(fields: [unidad_derivada_inmutable_id], references: [id], onDelete: Restrict, onUpdate: Cascade)

    producto_almacen_compra_id Int
    producto_almacen_compra    ProductoAlmacenCompra @relation(fields: [producto_almacen_compra_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

    factor       Decimal   @db.Decimal(9, 3)
    cantidad     Decimal   @db.Decimal(9, 3)
    lote         String?
    vencimiento  DateTime?
    flete        Decimal   @default(0) @db.Decimal(9, 4)
    bonificacion Boolean   @default(false)

    @@unique([producto_almacen_compra_id, unidad_derivada_inmutable_id, bonificacion])
}

model UnidadDerivadaInmutable {
    id   Int    @id @default(autoincrement())
    name String @unique

    unidades_derivadas_inmutables_en_compras  UnidadDerivadaInmutableCompra[]
    unidades_derivadas_inmutables_en_ingresos UnidadDerivadaInmutableIngresoSalida[]
    UnidadDerivadaInmutableRecepcion          UnidadDerivadaInmutableRecepcion[]
}
