enum TipoDocumento {
    Factura     @map("01")
    Boleta      @map("03")
    NotaDeVenta @map("nv")
    Ingreso     @map("in")
    Salida      @map("sa")
}

model Compra {
    id Int @id @default(autoincrement())

    tipo_documento TipoDocumento @default(NotaDeVenta)
    serie          String
    numero         Int
    descripcion    String?

    user_id String
    user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

    almacen_id Int
    almacen    Almacen @relation(fields: [almacen_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    productos_por_almacen ProductoAlmacenCompra[]

    @@unique([tipo_documento, serie, numero])
    @@index([created_at])
}

model ProductoAlmacenCompra {
    id Int @id @default(autoincrement())

    compra    Compra @relation(fields: [compra_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
    compra_id Int

    costo Decimal @db.Decimal(9, 4)

    producto_almacen    ProductoAlmacen @relation(fields: [producto_almacen_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
    producto_almacen_id Int

    unidades_derivadas UnidadDerivadaInmutableCompra[]

    @@unique([compra_id, producto_almacen_id])
}

model UnidadDerivadaInmutableCompra {
    id Int @id @default(autoincrement())

    unidad_derivada_inmutable_id Int
    unidad_derivada_inmutable    UnidadDerivadaInmutable @relation(fields: [unidad_derivada_inmutable_id], references: [id], onDelete: Restrict, onUpdate: Cascade)

    producto_almacen_compra_id Int
    producto_almacen_compra    ProductoAlmacenCompra @relation(fields: [producto_almacen_compra_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

    factor      Decimal   @db.Decimal(9, 3)
    cantidad    Decimal   @db.Decimal(9, 3)
    lote        String?
    vencimiento DateTime?
}

model UnidadDerivadaInmutable {
    id   Int    @id @default(autoincrement())
    name String @unique

    unidades_derivadas_inmutables_en_compras  UnidadDerivadaInmutableCompra[]
    unidades_derivadas_inmutables_en_ingresos UnidadDerivadaInmutableIngresoSalida[]
}
