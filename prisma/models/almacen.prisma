model Almacen {
    id   Int    @id @default(autoincrement())
    name String @unique

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    ubicaciones          Ubicacion[]
    productos_en_almacen ProductoAlmacen[]
    compras              Compra[]
    empresas             Empresa[]
}

model ProductoAlmacen {
    id Int @id @default(autoincrement())

    producto    Producto @relation(fields: [producto_id], references: [id])
    producto_id Int

    almacen    Almacen @relation(fields: [almacen_id], references: [id])
    almacen_id Int

    stock_fraccion Decimal @default(0) @db.Decimal(9, 3)
    costo          Decimal @default(0) @db.Decimal(9, 3)

    ubicacion    Ubicacion @relation(fields: [ubicacion_id], references: [id])
    ubicacion_id Int

    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    unidades_derivadas ProductoAlmacenUnidadDerivada[]
    compras            ProductoAlmacenCompra[]

    @@unique([producto_id, almacen_id])
}

model Ubicacion {
    id         Int    @id @default(autoincrement())
    name       String
    almacen_id Int

    almacen             Almacen           @relation(fields: [almacen_id], references: [id])
    productos_almacenes ProductoAlmacen[]

    @@unique([almacen_id, name])
    @@index([name])
}

model UnidadDerivada {
    id   Int    @id @default(autoincrement())
    name String @unique

    productos_almacenes_unidad_derivada ProductoAlmacenUnidadDerivada[]
}

model ProductoAlmacenUnidadDerivada {
    id Int @id @default(autoincrement())

    producto_almacen    ProductoAlmacen @relation(fields: [producto_almacen_id], references: [id])
    producto_almacen_id Int

    unidad_derivada    UnidadDerivada @relation(fields: [unidad_derivada_id], references: [id])
    unidad_derivada_id Int

    factor           Decimal  @db.Decimal(9, 3)
    precio_publico   Decimal  @db.Decimal(9, 3)
    comision_publico Decimal? @db.Decimal(9, 3)

    precio_especial    Decimal? @db.Decimal(9, 3)
    comision_especial  Decimal? @db.Decimal(9, 3)
    activador_especial Decimal? @db.Decimal(9, 3)

    precio_minimo    Decimal? @db.Decimal(9, 3)
    comision_minimo  Decimal? @db.Decimal(9, 3)
    activador_minimo Decimal? @db.Decimal(9, 3)

    precio_ultimo    Decimal? @db.Decimal(9, 3)
    comision_ultimo  Decimal? @db.Decimal(9, 3)
    activador_ultimo Decimal? @db.Decimal(9, 3)

    compras ProductoAlmacenUnidadDerivadaCompra[]

    @@unique([producto_almacen_id, unidad_derivada_id])
    @@unique([producto_almacen_id, factor])
}
